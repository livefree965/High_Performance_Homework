# 性能优化分析实验

#### 数据科学与计算机学院

#### 计算机科学与技术(超算方向)2016级

#### 16337259 谢江钊

## 实验结果

矩阵大小设定为4096*4096

### 耗时对比

![2018-09-10 11-10-07屏幕截图](C:\Users\xieji\OneDrive - mail2.sysu.edu.cn\高性能实验\第一次实验\2018-09-10 11-10-07屏幕截图.png)

取前五次平均数据进行对比:

|                  | 耗时（s） | 耗时百分比 |
| ---------------- | --------- | ---------- |
| 无改进耗时       | 0.31718   | 1          |
| 分块耗时         | 0.170602  | 0.537871   |
| 循环展开耗时     | 0.131523  | 0.414663   |
| 不同巡回路线耗时 | 0.151656  | 0.47814    |
| 最后尝试耗时     | 0.060323  | 0.190184   |

可见都得到了不同程度的提高。

### 缓存命中情况

无改进：

![无改进](C:\Users\xieji\Google 云端硬盘\第一次实验\无改进.png)

分块：

![分块](C:\Users\xieji\OneDrive - mail2.sysu.edu.cn\高性能实验\第一次实验\分块.png)

循环展开：

![循环展开](C:\Users\xieji\OneDrive - mail2.sysu.edu.cn\高性能实验\第一次实验\循环展开.png)

不同巡回：

![不同巡回](C:\Users\xieji\OneDrive - mail2.sysu.edu.cn\高性能实验\第一次实验\不同巡回.png)

最后尝试：

![最后尝试](C:\Users\xieji\OneDrive - mail2.sysu.edu.cn\高性能实验\第一次实验\最后尝试.png)

| 测试     | Cache miss次数 | miss百分比 |
| -------- | -------------- | ---------- |
| 无改进   | 55771183       | 1          |
| 分块     | 20043078       | 0.3593     |
| 循环展开 | 11490593       | 0.2060     |
| 不同巡回 | 19475530       | 0.3492     |
| 最后测试 | 11061684       | 0.1983     |

## 原因分析

### 未改进方案

![原始代码](C:\Users\xieji\OneDrive - mail2.sysu.edu.cn\高性能实验\第一次实验\原始代码.png)

### 分块技术



分块是一个很好的做法，因为注意到我们的矩阵有两个，其中一个在读写的时候会一行一行地取，而另一个读写时会一列一列地取。我们知道，在C语言中，二维矩阵其实是以一维的连续内存存储起来的。在进行缓存的时候，也是取的内存的相邻区域。因此，其中一个矩阵按行逐个读取会准确命中，但是对于另一个，尤其在矩阵比较大时，那么每次按列逐个读取的元素在内存中相距离较远，就容易发生缓存不足而miss掉的情况。尤其是当一列读取到最后一个元素，要回到第二列第一个元素读取的时候，这时两个元素在内存的距离是最远的，往往就会miss，为了解决这个问题，分块将这个范围缩小了，使得每个分块内部的元素距离比较小，因此提高了效率。

查阅了相关的资料（来源Intel:https://software.intel.com/en-us/articles/how-to-use-loop-blocking-to-optimize-memory-use-on-32-bit-intel-architecture），可以看到:

![82638_82638](C:\Users\xieji\Desktop\82638_82638.jpg)

很形象地表现出了这个优化地过程。

### 循环展开

![循环展开代码](C:\Users\xieji\OneDrive - mail2.sysu.edu.cn\高性能实验\第一次实验\循环展开代码.png)

循环展开主要是减少了分支预测失败带来的代价，否则根据for循环每次则都要进行判断，而分支预测在开始和结束的时候就可能要因为预测错误而回滚。

### 采用不同巡回路线

![不同巡回路线](C:\Users\xieji\OneDrive - mail2.sysu.edu.cn\高性能实验\第一次实验\不同巡回路线.png)

采用不同巡回路线，其实还是基于分块技术，性能差别不大，另外受到缓存本身大小的影响，相邻分块之间的物理位置可能会会稍微影响性能。前一个分块结束如果下一个分块部分已经在缓存中则会有相应的改善。

### 最后尝试

最后一个尝试将分块和循环展开结合了起来，而且，写入的地址连续了，这样可以减少存储器的写次数，因此能得到较大的加速。

